{{ if .Site.Params.contact.enable | default false }}
<section id="contact" class="py-5">
    <div class="container">
        <h3 class="text-center">{{ .Site.Params.contact.title | default "Контактная форма" }}</h3>
        <div class="px-0 px-md-5 px-lg-5">
            <div class="row justify-content-center">
                <div class="col-md-8 py-3">
                    <div class="text-center mb-4">
                        <h4>Записаться на занятие</h4>
                        <p class="text-muted">{{ .Site.Params.contact.content | default "Заполните форму и мы свяжемся с вами" }}</p>
                    </div>

                    {{ if .Site.Params.contact.formspree.enable | default false }}
                    <div class="row justify-content-center">
                        <form id="contact-form" onsubmit="handleFormspreeSubmit(event)" class="col-md-10">

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group pt-3">
                                        <label for="lastName" class="form-label">Фамилия <span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="lastName" name="lastName" required
                                            placeholder="Иванов">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group pt-3">
                                        <label for="firstName" class="form-label">Имя <span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="firstName" name="firstName" required
                                            placeholder="Иван">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group pt-3">
                                        <label for="telegram" class="form-label">Telegram <span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="telegram" name="telegram" required
                                            placeholder="@username">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group pt-3">
                                <label for="birthDate" class="form-label">Дата рождения</label>
                                <input type="text" class="form-control" id="birthDate" name="birthDate"
                                    placeholder="ДД.ММ.ГГГГ" maxlength="10">
                            </div>

                            <div class="form-group pt-3">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" name="email" required
                                    placeholder="ivan@example.com">
                            </div>

                            <div class="form-group pt-3 form-radio-wrapper">
                                <label class="form-label">Выберите формат обучения <span
                                        class="text-danger">*</span></label>
                                <div class="pt-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="learningFormat"
                                            id="individual" value="Индивидуальные занятия" required>
                                        <label class="form-check-label" for="individual">
                                            Индивидуальные занятия
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="learningFormat" id="couple"
                                            value="Парные занятия" required>
                                        <label class="form-check-label" for="couple">
                                            Парные занятия
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="learningFormat" id="group"
                                            value="Групповые занятия" required>
                                        <label class="form-check-label" for="group">
                                            Групповые занятия
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="learningFormat" id="speaking"
                                            value="Speaking Club" required>
                                        <label class="form-check-label" for="speaking">
                                            Speaking Club
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group pt-3">
                                <label for="message" class="form-label">Кратко опишите ваш запрос</label>
                                <textarea class="form-control" id="message" name="message"
                                    rows="{{ .Site.Params.contact.formspree.messageRows | default 4 }}"
                                    placeholder="Расскажите о ваших целях изучения языка, уровне подготовки и предпочтениях..."></textarea>
                            </div>

                            <div class="form-group pt-4 form-radio-wrapper">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="dataConsent" name="dataConsent"
                                        required>
                                    <label class="form-check-label small text-muted" for="dataConsent">
                                        <span class="text-danger">*</span> Я подтверждаю ознакомление с условиями
                                        <a href="/docs/personal-data/" target="_blank" class="consent-link">Согласия на
                                            обработку персональных данных</a>
                                        пользователя сайта и даю согласие на обработку моих персональных данных на
                                        указанных в нем порядке и условиях.
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="marketingConsent"
                                        name="marketingConsent">
                                    <label class="form-check-label small text-muted" for="marketingConsent">
                                        Даю
                                        <a href="/docs/marketing-consent/" target="_blank" class="consent-link">согласие на
                                            получение рекламных рассылок</a>
                                        (материалов)
                                    </label>
                                </div>
                            </div>

                            <div class="form-group text-center pt-4">
                                <button type="submit" class="btn btn-primary animation btn-lg px-5">{{
                                    .Site.Params.contact.btnName | default "Отправить заявку" }}</button>
                            </div>
                        </form>
                    </div>
                    {{ else if or (.Site.Params.contact.email) (.Site.Params.contact.btnLink) }}
                    <div class="text-center pt-3">
                        <a href='{{ if .Site.Params.contact.btnLink }}{{ .Site.Params.contact.btnLink | default "#" }}{{ else }}mailto:{{ .Site.Params.contact.email }}{{ end }}'
                            target="_blank" class="btn btn-primary btn-lg px-5">
                            {{ .Site.Params.contact.btnName | default "Связаться со мной" }}
                        </a>
                    </div>
                    {{ end }}
                </div>
            </div>
        </div>
    </div>
    <div id="contact-form-status"></div>
</section>

<style>
    .form-check-input {
        margin-top: 1px !important;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-color);
    }

    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 0.75rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        background-color: var(--background-color);
        color: var(--text-color);
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        background-color: var(--background-color);
        color: var(--text-color);
    }

    .form-control::placeholder {
        color: var(--text-secondary-color);
        opacity: 0.7;
    }

    /* Стили для радиокнопок */
    .form-check-input[type="radio"] {
        width: 20px;
        height: 20px;
        border: 2px solid var(--primary-color);
        background-color: transparent;
        border-radius: 50%;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .form-check-input[type="radio"]:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .form-check-input[type="radio"]:checked::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: white;
    }

    /* Стили для чекбоксов */
    .form-check-input[type="checkbox"] {
        width: 20px;
        height: 20px;
        border: 2px solid var(--primary-color);
        background-color: transparent;
        border-radius: 4px;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .form-check-input[type="checkbox"]:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .form-check-input[type="checkbox"]:checked::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 14px;
        line-height: 1;
    }

    .form-check {
        display: flex;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .form-check-label {
        margin-left: 0.75rem;
        cursor: pointer;
        color: var(--text-color);
        line-height: 1.4;
        flex: 1;
    }

    .form-check-label.small {
        font-size: 0.875rem;
        line-height: 1.3;
    }

    .text-danger {
        color: #dc3545 !important;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        color: white;
    }

    /* Тёмная тема */
    .dark .form-control {
        background-color: var(--secondary-background-color);
        border-color: #495057;
        color: var(--text-color-dark);
    }

    .dark .form-control:focus {
        background-color: var(--secondary-background-color);
        border-color: var(--primary-color-dark);
        color: var(--text-color-dark);
    }

    .dark .form-label {
        color: var(--text-color-dark);
    }

    .dark .form-check-label {
        color: var(--text-color-dark);
    }

    .dark .form-check-input[type="radio"],
    .dark .form-check-input[type="checkbox"] {
        border-color: var(--primary-color-dark);
    }

    .dark .form-check-input[type="radio"]:checked,
    .dark .form-check-input[type="checkbox"]:checked {
        background-color: #6c757d;
        border-color: var(--primary-color-dark);
    }

    /* Стили для ссылок в форме */
    .consent-link {
        color: var(--primary-color);
        text-decoration: underline;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .consent-link:hover {
        color: var(--primary-color);
        text-decoration: none;
        opacity: 0.8;
    }

    /* Темная тема */
    .dark .consent-link {
        color: var(--primary-color-dark);
    }

    .dark .consent-link:hover {
        color: var(--primary-color-dark);
        opacity: 0.8;
    }

    .spinner-border {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        vertical-align: text-bottom;
        border: 0.2em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
    }

    .spinner-border-sm {
        width: 0.875rem;
        height: 0.875rem;
        border-width: 0.15em;
    }

    @keyframes spinner-border {
        to {
            transform: rotate(360deg);
        }
    }

    .alert {
        display: flex;
        align-items: flex-start;
        padding: 1rem;
        margin-bottom: 1rem;
        gap: 10px;
        border: 1px solid transparent;
        border-radius: 0.375rem;
    }

    .alert svg {
        flex-shrink: 0;
        margin-top: 0.125rem;
    }

    .alert-success {
        color: #0f5132;
        background-color: #d1e7dd;
        border-color: #badbcc;
    }

    .alert-danger {
        color: #842029;
        background-color: #f8d7da;
        border-color: #f5c2c7;
    }

    .alert-link {
        font-weight: 700;
        color: inherit;
        text-decoration: underline;
    }

    .alert-link:hover {
        opacity: 0.8;
    }

    .dark .alert-success {
        color: #75b798;
        background-color: #051b11;
        border-color: #0f5132;
    }

    .dark .alert-danger {
        color: #ea868f;
        background-color: #2c0b0e;
        border-color: #842029;
    }

    .btn-close {
        background: transparent;
        border: 0;
        padding: 0.5rem;
        margin-left: auto;
        cursor: pointer;
        opacity: 0.5;
        font-size: 1.5rem;
        line-height: 1;
        color: inherit;
    }

    .btn-close:hover {
        opacity: 1;
    }

    .btn-close::before {
        content: "×";
    }
    #contact-form {
        width: 100%;
    }

    /* Улучшенная видимость для мобильных */
    @media (max-width: 768px) {
        .consent-link {
            text-decoration-thickness: 2px;
        }
    }

    /* Фокус для доступности */
    .consent-link:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
        border-radius: 2px;
    }

    @media (max-width: 768px) {
        .row .col-md-4 {
            margin-bottom: 1rem;
        }

        .form-check-input[type="radio"],
        .form-check-input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .form-check-label {
            margin-left: 0.5rem;
            font-size: 0.9rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('contact-form');
        const birthDateInput = document.getElementById('birthDate');

        // Маска для ввода даты в российском формате
        if (birthDateInput) {
            // Маска для ввода
            birthDateInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, ''); // Удаляем всё кроме цифр

                // Форматируем как ДД.ММ.ГГГГ
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '.' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '.' + value.substring(5, 9);
                }

                e.target.value = value;
            });

            // Валидация при потере фокуса
            birthDateInput.addEventListener('blur', function (e) {
                const value = e.target.value;

                if (!value) {
                    e.target.setCustomValidity('');
                    return; // Поле необязательное
                }

                const datePattern = /^(0[1-9]|[12][0-9]|3[01])\.(0[1-9]|1[0-2])\.(19|20)\d{2}$/;

                if (!datePattern.test(value)) {
                    e.target.setCustomValidity('Введите дату в формате ДД.ММ.ГГГГ');
                    e.target.reportValidity();
                    return;
                }

                // Проверка корректности даты
                const parts = value.split('.');
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);
                const date = new Date(year, month - 1, day);

                if (date.getFullYear() !== year ||
                    date.getMonth() !== month - 1 ||
                    date.getDate() !== day) {
                    e.target.setCustomValidity('Введите корректную дату');
                    e.target.reportValidity();
                } else {
                    e.target.setCustomValidity('');
                }
            });

            // Очистка ошибки при вводе
            birthDateInput.addEventListener('input', function (e) {
                e.target.setCustomValidity('');
            });
        }

        if (form) {
            form.addEventListener('submit', function (e) {
                const dataConsent = document.getElementById('dataConsent');
                const learningFormat = document.querySelector('input[name="learningFormat"]:checked');

                if (!dataConsent.checked) {
                    e.preventDefault();
                    alert('Необходимо дать согласие на обработку персональных данных');
                    return false;
                }

                if (!learningFormat) {
                    e.preventDefault();
                    alert('Необходимо выбрать формат обучения');
                    return false;
                }
            });
        }
    });

    async function handleFormspreeSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const statusDiv = document.getElementById('contact-form-status');

        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Отправка...';

        try {
            const formData = {
                firstName: form.firstName.value,
                lastName: form.lastName.value,
                telegram: form.telegram.value,
                email: form.email.value,
                birthDate: form.birthDate.value || 'Не указана',
                learningFormat: form.querySelector('input[name="learningFormat"]:checked').value,
                message: form.message.value || 'Не указано',
                dataConsent: form.dataConsent.checked ? true : false,
                marketingConsent: form.marketingConsent.checked ? true : false
            };

            const response = await fetch(
                'https://thetutoress.ru/api/thetutoress-lead',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Telegram API error:', errorData);
                throw new Error('Ошибка отправки в Telegram');
            }

            statusDiv.innerHTML = `
            <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Success:">
                    <use xlink:href="#check-circle-fill"/>
                </svg>
                <strong>Отлично!</strong> Ваша заявка успешно отправлена. Мы свяжемся с вами в ближайшее время через Telegram.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;

            form.reset();

        } catch (error) {
            console.error('Ошибка:', error);

            statusDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Error:">
                    <use xlink:href="#exclamation-triangle-fill"/>
                </svg>
                <strong>Ошибка!</strong> Не удалось отправить заявку. Пожалуйста, напишите нам напрямую в 
                <a href="https://t.me/patrikalina" target="_blank" class="alert-link">Telegram</a> или на 
                <a href="mailto:thetutoress.eng@gmail.com" class="alert-link">Email</a>.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = '{{ .Site.Params.contact.btnName | default "Отправить заявку" }}';
            statusDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    // Обработка закрытия алертов
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('btn-close')) {
            e.target.closest('.alert').remove();
        }
    });
</script>

{{ end }}

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="check-circle-fill" viewBox="0 0 16 16">
        <path
            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
    </symbol>
    <symbol id="info-fill" viewBox="0 0 16 16">
        <path
            d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" />
    </symbol>
    <symbol id="exclamation-triangle-fill" viewBox="0 0 16 16">
        <path
            d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
    </symbol>
</svg>